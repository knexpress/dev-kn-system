require('dotenv').config();
const mongoose = require('mongoose');
const { Report } = require('../models');

// Helper to extract timestamp from ObjectId
function getTimestampFromObjectId(objectId) {
  if (!objectId) return null;
  const id = objectId.toString();
  if (id.length === 24) {
    const timestamp = parseInt(id.substring(0, 8), 16) * 1000;
    return new Date(timestamp);
  }
  return null;
}

async function checkDecemberReports() {
  try {
    console.log('üîå Connecting to MongoDB...');
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('‚úÖ Connected to MongoDB\n');

    // December 4, 2025 - ObjectId timestamp range
    // ObjectId timestamp for Dec 4, 2025 00:00:00 UTC = 1733270400000
    // ObjectId timestamp for Dec 6, 2025 00:00:00 UTC = 1733443200000
    const dec4Start = new Date('2025-12-04T00:00:00.000Z');
    const dec6Start = new Date('2025-12-06T00:00:00.000Z');
    
    console.log(`üîç Searching for reports between ${dec4Start.toISOString()} and ${dec6Start.toISOString()}\n`);

    // Query by createdAt and generatedAt
    const reports = await Report.find({
      $or: [
        { createdAt: { $gte: dec4Start, $lt: dec6Start } },
        { generatedAt: { $gte: dec4Start, $lt: dec6Start } }
      ]
    })
      .populate('generated_by_employee_id', 'full_name email')
      .sort({ createdAt: -1 })
      .lean();

    console.log(`üìä Found ${reports.length} reports from December 4-5, 2025\n`);

    if (reports.length > 0) {
      console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
      console.log('üìã DECEMBER 4-5, 2025 REPORTS');
      console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
      
      reports.forEach((report, index) => {
        const objIdDate = getTimestampFromObjectId(report._id);
        console.log(`${index + 1}. ${report.title || 'Untitled Report'}`);
        console.log(`   ID: ${report._id}`);
        console.log(`   ObjectId Date: ${objIdDate ? objIdDate.toISOString() : 'N/A'}`);
        console.log(`   Created At: ${report.createdAt ? new Date(report.createdAt).toISOString() : 'N/A'}`);
        console.log(`   Generated At: ${report.generatedAt ? new Date(report.generatedAt).toISOString() : 'N/A'}`);
        console.log(`   Generated By: ${report.generated_by_employee_id?.full_name || report.generated_by_employee_name || 'N/A'}`);
        
        if (report.report_data) {
          const data = report.report_data;
          console.log(`   AWB: ${data.awb_number || 'N/A'}`);
          console.log(`   Customer: ${data.customer_name || 'N/A'}`);
          console.log(`   Transaction Date: ${data.transaction_date || 'N/A'}`);
        }
        console.log('');
      });
    } else {
      console.log('‚ö†Ô∏è  No reports found for December 4-5, 2025\n');
      
      // Check what dates we do have around that time
      console.log('üîç Checking reports around that time period...\n');
      
      const dec3Start = new Date('2025-12-03T00:00:00.000Z');
      const dec7Start = new Date('2025-12-07T00:00:00.000Z');
      
      const nearbyReports = await Report.find({
        $or: [
          { createdAt: { $gte: dec3Start, $lt: dec7Start } },
          { generatedAt: { $gte: dec3Start, $lt: dec7Start } }
        ]
      })
        .select('_id title createdAt generatedAt')
        .sort({ createdAt: -1 })
        .limit(20)
        .lean();
      
      console.log(`üìä Found ${nearbyReports.length} reports from December 3-6, 2025:\n`);
      
      nearbyReports.forEach((report, index) => {
        const objIdDate = getTimestampFromObjectId(report._id);
        console.log(`${index + 1}. ${report.title || 'Untitled'}`);
        console.log(`   ID: ${report._id}`);
        console.log(`   ObjectId Date: ${objIdDate ? objIdDate.toISOString() : 'N/A'}`);
        console.log(`   Created: ${report.createdAt ? new Date(report.createdAt).toISOString() : 'N/A'}`);
        console.log(`   Generated: ${report.generatedAt ? new Date(report.generatedAt).toISOString() : 'N/A'}`);
        console.log('');
      });
    }

    // Also check by ObjectId timestamp directly
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üîç Checking by ObjectId timestamp...');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
    
    // Get all reports and check their ObjectId timestamps
    const allRecentReports = await Report.find({})
      .select('_id title createdAt generatedAt')
      .sort({ _id: -1 })
      .limit(200)
      .lean();
    
    const reportsByObjId = allRecentReports
      .map(report => {
        const objIdDate = getTimestampFromObjectId(report._id);
        return { ...report, objIdDate };
      })
      .filter(report => {
        if (!report.objIdDate) return false;
        return report.objIdDate >= dec4Start && report.objIdDate < dec6Start;
      });
    
    console.log(`üìä Reports found by ObjectId timestamp (Dec 4-5): ${reportsByObjId.length}\n`);
    
    if (reportsByObjId.length > 0) {
      reportsByObjId.slice(0, 20).forEach((report, index) => {
        console.log(`${index + 1}. ${report.title || 'Untitled'}`);
        console.log(`   ID: ${report._id}`);
        console.log(`   ObjectId Date: ${report.objIdDate.toISOString()}`);
        console.log(`   Created: ${report.createdAt ? new Date(report.createdAt).toISOString() : 'N/A'}`);
        console.log('');
      });
    }

    process.exit(0);
  } catch (error) {
    console.error('‚ùå Error checking reports:', error);
    process.exit(1);
  } finally {
    await mongoose.connection.close();
    console.log('üîå MongoDB connection closed');
  }
}

checkDecemberReports();






